# 0 è½®è¯¢ç®±å­å¯è§æ€§ç›‘æ§ç³»ç»Ÿå®ç°æ€»ç»“

## ğŸ¯ å®ç°ç›®æ ‡
é€šè¿‡ Harmony Hook å®ç° **0 è½®è¯¢** çš„ç®±å­å¯è§æ€§åŠ¨æ€ç›‘æ§ï¼Œè‡ªåŠ¨è¿½è¸ª/ç§»é™¤å—ä»»åŠ¡ã€è“å›¾ã€æ¦‚ç‡ç­‰æ¡ä»¶æ§åˆ¶çš„ç®±å­ã€‚

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### `LootboxVisibilityHook.cs`
**ä½ç½®**: `DuckovESPv3/Core/Systems/ESP/Hooks/LootboxVisibilityHook.cs`

**åŠŸèƒ½**: 
- Hook æ¸¸æˆåŸç”Ÿçš„ç®±å­å¯è§æ€§æ§åˆ¶æ–¹æ³•
- å‘å¸ƒç®±å­å¯è§æ€§å˜åŒ–äº‹ä»¶

**Hook çš„æ–¹æ³•**:
1. **SetActiveByCondition.Set()** - æ¡ä»¶è¯„ä¼°ç³»ç»Ÿ
   - ä»»åŠ¡æ¿€æ´»/å®Œæˆæ§åˆ¶
   - è“å›¾è§£é”æ§åˆ¶
   - æŠ€èƒ½è§£é”æ§åˆ¶
   - æ—¶é—´/å¤©æ°”/ç­‰çº§ç­‰æ¡ä»¶

2. **LootBoxLoader.RandomActive()** - æ¦‚ç‡ç”Ÿæˆç³»ç»Ÿ
   - ç®±å­ç”Ÿæˆæ¦‚ç‡æ§åˆ¶
   - åŸºäº `activeChance` å­—æ®µï¼ˆ0-1ï¼‰

**äº‹ä»¶**:
```csharp
public static event Action<InteractableLootbox, bool> OnLootboxVisibilityChanged;
// å‚æ•°: (ç®±å­å¯¹è±¡, æ˜¯å¦å¯è§)
```

---

## ğŸ”„ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `LootboxDataCollector.cs`

#### æ·»åŠ çš„åŠŸèƒ½:
- è®¢é˜… `LootboxVisibilityHook.OnLootboxVisibilityChanged` äº‹ä»¶
- å®ç° `HandleLootboxVisibilityChanged()` å¤„ç†æ–¹æ³•

#### å¤„ç†é€»è¾‘:
```csharp
private void HandleLootboxVisibilityChanged(InteractableLootbox lootbox, bool isVisible)
{
    if (isVisible)
    {
        // ç®±å­å˜ä¸ºå¯è§ â†’ æ·»åŠ è¿½è¸ª
        if (!_discoveredBoxes.Contains(lootbox))
        {
            ProcessLootbox(lootbox, lootbox.Inventory);
            // å‘å¸ƒ LootboxDiscoveredEvent
        }
    }
    else
    {
        // ç®±å­å˜ä¸ºä¸å¯è§ â†’ ç§»é™¤è¿½è¸ª
        if (_trackedLootboxes.ContainsKey(lootbox))
        {
            _trackedLootboxes.Remove(lootbox);
            _discoveredBoxes.Remove(lootbox);
            // å‘å¸ƒ LootboxRemovedEvent
        }
    }
}
```

#### è®¢é˜…ä½ç½®:
```csharp
public void Initialize()
{
    // è®¢é˜…ç®±å­ç”Ÿæˆäº‹ä»¶
    LootboxSpawnHook.OnLootboxSpawned += HandleLootboxSpawned;
    
    // è®¢é˜…ç®±å­å¯è§æ€§å˜åŒ–äº‹ä»¶ï¼ˆNEWï¼‰
    Hooks.LootboxVisibilityHook.OnLootboxVisibilityChanged += HandleLootboxVisibilityChanged;
    
    // æ‰«æç°æœ‰ç®±å­
    ScanExistingLootboxes();
}
```

#### æ¸…ç†é€»è¾‘:
```csharp
public void Cleanup()
{
    LootboxSpawnHook.OnLootboxSpawned -= HandleLootboxSpawned;
    Hooks.LootboxVisibilityHook.OnLootboxVisibilityChanged -= HandleLootboxVisibilityChanged;
    // ...
}
```

---

### 2. `ModBehaviour.cs`

#### æ·»åŠ çš„åŠŸèƒ½:
åœ¨ `Awake()` ä¸­åº”ç”¨ `LootboxVisibilityHook` çš„ Patches

```csharp
private void Awake()
{
    // åº”ç”¨ Harmony Patches
    _harmony = new Harmony("com.duckov.espv3");
    _harmony.PatchAll(Assembly.GetExecutingAssembly());
    
    // åˆå§‹åŒ–æœåŠ¡å®¹å™¨
    _serviceContainer = new ServiceContainer();
    RegisterServices();
    
    _logger = _serviceContainer.Resolve<ILogger>();
    
    // åº”ç”¨ç®±å­å¯è§æ€§ Hookï¼ˆNEWï¼‰
    DuckovESPv3.Core.Systems.ESP.Hooks.LootboxVisibilityHook.ApplyPatches(_harmony, _logger);
    
    // ...
}
```

---

## ğŸ” å·¥ä½œæµç¨‹

### åœºæ™¯ 1: ä»»åŠ¡æ¿€æ´»çš„ç®±å­

**æ—¶é—´çº¿**:
```
1. å…³å¡åŠ è½½
2. SetActiveByCondition.Update() æ‰§è¡Œ
3. conditions.Satisfied() è¿”å› falseï¼ˆä»»åŠ¡æœªæ¿€æ´»ï¼‰
4. targetObject.SetActive(false)  â† Hook æ•è·
5. LootboxVisibilityHook è§¦å‘äº‹ä»¶: (lootbox, false)
6. LootboxDataCollector æ”¶åˆ°äº‹ä»¶ï¼Œè·³è¿‡è¿½è¸ªè¯¥ç®±å­

---ç©å®¶æ¥å–ä»»åŠ¡---

7. ä»»åŠ¡çŠ¶æ€æ”¹å˜
8. SetActiveByCondition.CheckAndLoop() æ‰§è¡Œï¼ˆæ¯ç§’æ£€æŸ¥ï¼‰
9. conditions.Satisfied() è¿”å› true
10. targetObject.SetActive(true)  â† Hook æ•è·
11. LootboxVisibilityHook è§¦å‘äº‹ä»¶: (lootbox, true)
12. LootboxDataCollector æ”¶åˆ°äº‹ä»¶ï¼Œå¼€å§‹è¿½è¸ªè¯¥ç®±å­
13. å‘å¸ƒ LootboxDiscoveredEvent â†’ åˆ›å»ºå°åœ°å›¾æ ‡è®°

---ç©å®¶å®Œæˆä»»åŠ¡---

14. ä»»åŠ¡çŠ¶æ€æ”¹å˜
15. SetActiveByCondition.CheckAndLoop() æ‰§è¡Œ
16. conditions.Satisfied() è¿”å› false
17. targetObject.SetActive(false)  â† Hook æ•è·
18. LootboxVisibilityHook è§¦å‘äº‹ä»¶: (lootbox, false)
19. LootboxDataCollector æ”¶åˆ°äº‹ä»¶ï¼Œç§»é™¤è¿½è¸ª
20. å‘å¸ƒ LootboxRemovedEvent â†’ ç§»é™¤å°åœ°å›¾æ ‡è®°
```

---

### åœºæ™¯ 2: æ¦‚ç‡ç”Ÿæˆçš„ç®±å­

**æ—¶é—´çº¿**:
```
1. å…³å¡åŠ è½½
2. LootBoxLoader.Awake() æ‰§è¡Œ
3. LootBoxLoader.RandomActive() æ‰§è¡Œ
4. Random.Range(0, 1) < activeChance
   - å‡è®¾ activeChance = 0.3ï¼Œç»“æœ = 0.7 â†’ ä¸ç”Ÿæˆ
5. gameObject.SetActive(false)  â† Hook æ•è·
6. LootboxVisibilityHook è§¦å‘äº‹ä»¶: (lootbox, false)
7. LootboxDataCollector æ”¶åˆ°äº‹ä»¶ï¼Œä¸è¿½è¸ªè¯¥ç®±å­
8. å°åœ°å›¾ä¸Šä¸ä¼šå‡ºç°æ­¤ç®±å­æ ‡è®°

---é‡æ–°åŠ è½½å…³å¡ï¼ˆæ–°ä¸€è½®éšæœºï¼‰---

9. RandomActive() å†æ¬¡æ‰§è¡Œ
10. Random.Range(0, 1) = 0.15 < 0.3 â†’ ç”Ÿæˆ
11. gameObject.SetActive(true)  â† Hook æ•è·
12. LootboxVisibilityHook è§¦å‘äº‹ä»¶: (lootbox, true)
13. LootboxDataCollector å¼€å§‹è¿½è¸ª
14. å°åœ°å›¾å‡ºç°æ ‡è®°
```

---

### åœºæ™¯ 3: è“å›¾é”å®šçš„ç®±å­

**æ—¶é—´çº¿**:
```
1. å…³å¡åŠ è½½
2. SetActiveByCondition è¯„ä¼° RequireFormulaUnlocked
3. CraftingManager.IsFormulaUnlocked("AK47Blueprint") è¿”å› false
4. gameObject.SetActive(false)  â† Hook æ•è·
5. ç®±å­ä¸è¢«è¿½è¸ªï¼Œå°åœ°å›¾æ— æ ‡è®°

---ç©å®¶è§£é”è“å›¾---

6. ç©å®¶æ‹¾å–è“å›¾ç‰©å“
7. CraftingManager.UnlockFormula("AK47Blueprint")
8. SetActiveByCondition.CheckAndLoop() æ£€æµ‹åˆ°å˜åŒ–
9. gameObject.SetActive(true)  â† Hook æ•è·
10. ç®±å­å¼€å§‹è¿½è¸ªï¼Œå°åœ°å›¾å‡ºç°æ ‡è®°
```

---

## âš¡ æ€§èƒ½ä¼˜åŠ¿

### å¯¹æ¯”ä¼ ç»Ÿè½®è¯¢æ–¹æ¡ˆ:

| æŒ‡æ ‡ | è½®è¯¢æ–¹æ¡ˆ | Hook æ–¹æ¡ˆï¼ˆ0è½®è¯¢ï¼‰ |
|------|---------|-------------------|
| **CPU å¼€é”€** | æ¯ç§’æ£€æŸ¥æ‰€æœ‰ç®±å­ | ä»…åœ¨çŠ¶æ€å˜åŒ–æ—¶æ‰§è¡Œ |
| **æ£€æŸ¥é¢‘ç‡** | 1 æ¬¡/ç§’ Ã— N ä¸ªç®±å­ | 0 æ¬¡ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ |
| **å“åº”å»¶è¿Ÿ** | æœ€é«˜ 1 ç§’ | å³æ—¶ï¼ˆ<1msï¼‰ |
| **å†…å­˜åˆ†é…** | æŒç»­åˆ†é…è¿­ä»£å™¨ | é›¶é¢å¤–åˆ†é… |
| **GC å‹åŠ›** | ä¸­ç­‰ | æä½ |

**ç¤ºä¾‹è®¡ç®—**ï¼ˆ100 ä¸ªç®±å­åœºæ™¯ï¼‰:
- **è½®è¯¢**: 100 æ¬¡æ£€æŸ¥/ç§’ Ã— 60 ç§’ = 6000 æ¬¡æ£€æŸ¥/åˆ†é’Ÿ
- **Hook**: ä»…åœ¨ä»»åŠ¡æ¿€æ´»æ—¶è§¦å‘ 1 æ¬¡ï¼Œæ€»è®¡ ~10 æ¬¡/åˆ†é’Ÿ

**æ€§èƒ½æå‡**: ~600 å€ å‡å°‘

---

## ğŸ›¡ï¸ é²æ£’æ€§ä¿è¯

### 1. Hook å¤±è´¥ä¿æŠ¤
```csharp
try
{
    LootboxVisibilityHook.ApplyPatches(_harmony, _logger);
}
catch (Exception ex)
{
    _logger?.Error($"ç®±å­å¯è§æ€§ Hook åº”ç”¨å¤±è´¥: {ex}");
    // ç³»ç»Ÿç»§ç»­è¿è¡Œï¼Œä¾èµ–åˆå§‹æ‰«æçš„ activeInHierarchy æ£€æŸ¥
}
```

### 2. äº‹ä»¶å¤„ç†å¼‚å¸¸éš”ç¦»
```csharp
private void HandleLootboxVisibilityChanged(InteractableLootbox lootbox, bool isVisible)
{
    try
    {
        // å¤„ç†é€»è¾‘
    }
    catch (Exception ex)
    {
        _logger.Error($"å¤„ç†ç®±å­å¯è§æ€§å˜åŒ–å¤±è´¥: {ex.Message}");
        // ä¸å½±å“å…¶ä»–ç®±å­çš„å¤„ç†
    }
}
```

### 3. ç»„ä»¶ç¼ºå¤±å®¹é”™
```csharp
// Hook å†…éƒ¨æ£€æŸ¥
var lootbox = targetObject.GetComponent<InteractableLootbox>();
if (lootbox == null)
{
    lootbox = targetObject.GetComponentInParent<InteractableLootbox>();
    if (lootbox == null)
        return;  // ä¸æ˜¯ç®±å­ï¼Œå¿½ç•¥
}
```

---

## ğŸ“Š æ”¯æŒçš„å¯è§æ€§æ§åˆ¶ç±»å‹

| æ§åˆ¶ç±»å‹ | æ¸¸æˆç»„ä»¶ | Hook æ–¹æ³• | ç¤ºä¾‹åœºæ™¯ |
|---------|---------|-----------|---------|
| **ä»»åŠ¡æ¡ä»¶** | SetActiveByCondition + RequireQuestsActive | Set() | ä»»åŠ¡æœŸé—´å¯è§çš„ç®±å­ |
| **ä»»åŠ¡å®Œæˆ** | SetActiveByCondition + RequireQuestsFinished | Set() | ä»»åŠ¡åè§£é”çš„ç®±å­ |
| **è“å›¾è§£é”** | SetActiveByCondition + RequireFormulaUnlocked | Set() | è§£é”é…æ–¹åå¯è§ |
| **æŠ€èƒ½è§£é”** | SetActiveByCondition + RequirePerkUnlocked | Set() | ç‰¹å®šæŠ€èƒ½åå¯è§ |
| **ç­‰çº§è¦æ±‚** | SetActiveByCondition + Condition_CharacterLevel | Set() | è¾¾åˆ°ç­‰çº§åå¯è§ |
| **æ—¶é—´æ®µ** | SetActiveByCondition + Condition_TimeOfDay | Set() | ç‰¹å®šæ—¶é—´å¯è§ |
| **æ¦‚ç‡ç”Ÿæˆ** | LootBoxLoader | RandomActive() | éšæœºå‡ºç°çš„ç®±å­ |
| **ä¿¡æ ‡è§£é”** | SetActiveByCondition + RequireBeaconUnlocked | Set() | æ¿€æ´»ä¿¡æ ‡åå¯è§ |

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯• 1: ä»»åŠ¡é”å®šç®±å­
1. è¿›å…¥æœ‰ä»»åŠ¡ç®±å­çš„å…³å¡
2. æŸ¥çœ‹æ—¥å¿—ï¼š`ç®±å­åŠ¨æ€å˜ä¸ºä¸å¯è§ï¼Œç§»é™¤è¿½è¸ª`
3. æ¥å–ä»»åŠ¡
4. æŸ¥çœ‹æ—¥å¿—ï¼š`ç®±å­åŠ¨æ€å˜ä¸ºå¯è§ï¼Œå¼€å§‹è¿½è¸ª`
5. å°åœ°å›¾ä¸Šå‡ºç°æ–°æ ‡è®°

### æµ‹è¯• 2: æ¦‚ç‡ç”Ÿæˆç®±å­
1. å¤šæ¬¡é‡æ–°åŠ è½½åŒä¸€å…³å¡
2. è§‚å¯Ÿä¸åŒæ¬¡æ•°çš„ç®±å­æ•°é‡
3. æŸ¥çœ‹æ—¥å¿—ï¼š`LootBoxLoader éšæœºæ¿€æ´»ç®±å­: XXX â†’ ç”Ÿæˆ/æœªç”Ÿæˆ`

### æµ‹è¯• 3: è“å›¾ç®±å­
1. æœªè§£é”è“å›¾æ—¶è¿›å…¥å…³å¡
2. ç®±å­ä¸å¯è§ï¼Œå°åœ°å›¾æ— æ ‡è®°
3. è§£é”è“å›¾
4. æŸ¥çœ‹æ—¥å¿—ï¼š`ç®±å­åŠ¨æ€å˜ä¸ºå¯è§`
5. å°åœ°å›¾å‡ºç°æ–°æ ‡è®°

### æµ‹è¯• 4: Hook å¤±è´¥é™çº§
1. åˆ é™¤ Hook ç›¸å…³ä»£ç ï¼ˆæ¨¡æ‹Ÿå¤±è´¥ï¼‰
2. ç³»ç»Ÿä»ç„¶èƒ½è¿è¡Œï¼Œä¾èµ–åˆå§‹æ‰«æ
3. åŠ¨æ€å˜åŒ–çš„ç®±å­ä¸ä¼šæ›´æ–°ï¼ˆé¢„æœŸè¡Œä¸ºï¼‰

---

## âœ… å®ç°æ€»ç»“

### ä¼˜åŠ¿:
1. âœ… **çœŸæ­£çš„ 0 è½®è¯¢** - äº‹ä»¶é©±åŠ¨ï¼Œæ— å®šæ—¶å™¨
2. âœ… **å³æ—¶å“åº”** - Hook æ•è·çŠ¶æ€å˜åŒ–çš„ç¬é—´
3. âœ… **æä½å¼€é”€** - ä»…åœ¨çŠ¶æ€å˜åŒ–æ—¶æ‰§è¡Œ
4. âœ… **å®Œæ•´è¦†ç›–** - æ”¯æŒæ‰€æœ‰æ¸¸æˆåŸç”Ÿçš„å¯è§æ€§æ§åˆ¶æ–¹å¼
5. âœ… **é²æ£’æ€§é«˜** - Hook å¤±è´¥ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
6. âœ… **æ˜“äºç»´æŠ¤** - æ¸…æ™°çš„äº‹ä»¶æµï¼Œæ˜“äºè°ƒè¯•

### æ¶æ„:
```
æ¸¸æˆåŸç”Ÿæ–¹æ³•
    â†“
Harmony Hook (Postfix)
    â†“
LootboxVisibilityHook äº‹ä»¶
    â†“
LootboxDataCollector å¤„ç†
    â†“
EventBus å‘å¸ƒäº‹ä»¶
    â†“
MinimapMarkerService æ›´æ–°æ ‡è®°
```

### å…¼å®¹æ€§:
- âœ… ä¸ä¿®æ”¹æ¸¸æˆåŸæœ‰é€»è¾‘
- âœ… Postfix Hookï¼Œä¸é˜»æ–­åŸæ–¹æ³•æ‰§è¡Œ
- âœ… å¼‚å¸¸éš”ç¦»ï¼Œä¸å½±å“æ¸¸æˆç¨³å®šæ€§
- âœ… å¯åœ¨è¿è¡Œæ—¶ç¦ç”¨ï¼ˆå–æ¶ˆè®¢é˜…äº‹ä»¶ï¼‰
