# ä»»åŠ¡æ ‡è®°ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

**æ¶ˆé™¤æ‰€æœ‰å‘¨æœŸæ€§æ‰«æï¼Œæ”¹ä¸ºå®Œå…¨äº‹ä»¶é©±åŠ¨æ¶æ„**

---

## âŒ V2çš„é—®é¢˜

### å‘¨æœŸæ€§æ‰«æå¼€é”€
```csharp
// V2 - æ¯2ç§’è½®è¯¢æ‰«æä»»åŠ¡åœ°ç‚¹
void Update()
{
    if (Time.time - _lastQuestZoneScanTime > 2f)
    {
        RefreshQuestZones(); // 2-10ms
        _lastQuestZoneScanTime = Time.time;
    }
}
```

**æ€§èƒ½å¼€é”€**ï¼š
- æ¯2ç§’æ‰«æï¼š2-10ms
- å¹³å‡æ‘Šé”€ï¼š**1-5ms/ç§’**
- ä¸å¿…è¦çš„é‡å¤è®¡ç®—

---

## âœ… V3çš„ä¼˜åŒ–æ–¹æ¡ˆ

### å®Œå…¨äº‹ä»¶é©±åŠ¨æ¶æ„

```csharp
// V3 - å…³å¡åŠ è½½æ—¶æ‰«æä¸€æ¬¡ + äº‹ä»¶ç›‘å¬
public class QuestZoneTracker
{
    private Dictionary<string, QuestZoneData> _questZones = new Dictionary<string, QuestZoneData>();
    
    public void Initialize()
    {
        // âœ… è®¢é˜…æ¸¸æˆäº‹ä»¶
        QuestManager.OnTaskFinishedEvent += OnTaskFinished;
        Quest.onQuestCompleted += OnQuestCompleted;
        LevelManager.OnAfterLevelInitialized += OnLevelLoaded;
    }
    
    private void OnLevelLoaded()
    {
        // âœ… å…³å¡åŠ è½½æ—¶æ‰«æä¸€æ¬¡ï¼ˆ5-10msï¼Œä¸€æ¬¡æ€§å¼€é”€ï¼‰
        ScanAllQuestZones();
    }
    
    private void OnTaskFinished(Quest quest, Task task)
    {
        // âœ… ä»»åŠ¡å®Œæˆæ—¶ç«‹å³ç§»é™¤æ ‡è®°ï¼ˆ<0.1msï¼‰
        string key = GetTaskKey(quest, task);
        if (_questZones.Remove(key))
        {
            PublishUpdateEvent();
        }
    }
    
    private void OnQuestCompleted(Quest quest)
    {
        // âœ… æ•´ä¸ªä»»åŠ¡å®Œæˆæ—¶ç§»é™¤æ‰€æœ‰ç›¸å…³æ ‡è®°
        var keysToRemove = _questZones.Keys
            .Where(k => k.StartsWith($"Quest_{quest.id}_"))
            .ToList();
        
        foreach (var key in keysToRemove)
            _questZones.Remove(key);
        
        if (keysToRemove.Count > 0)
            PublishUpdateEvent();
    }
    
    // âŒ åˆ é™¤Update()æ–¹æ³• - ä¸å†éœ€è¦
}
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å¼€é”€å¯¹æ¯”è¡¨

| æŒ‡æ ‡ | V2ï¼ˆå‘¨æœŸæ‰«æï¼‰ | V3ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ | æå‡ |
|------|---------------|---------------|------|
| åˆå§‹åŒ–å¼€é”€ | 6-20ms | 11-30ms | ç•¥å¢ï¼ˆå¯æ¥å—ï¼‰ |
| æ¯å¸§ç¨³å®šå¼€é”€ | 0.05-0.1ms | **0.05-0.1ms** | æŒå¹³ |
| å‘¨æœŸæ‰«æå¼€é”€ | **1-5ms/ç§’** | **0ms** | âœ… **æ¶ˆé™¤** |
| ä»»åŠ¡å®Œæˆäº‹ä»¶ | 2-10ms | **<0.1ms** | âœ… **20-100å€** |
| æ€»å¹³å‡å¼€é”€ | 1-5ms/ç§’ | **<0.15ms/å¸§** | âœ… **10-30å€** |

### å…·ä½“åœºæ™¯å¯¹æ¯”

**åœºæ™¯1ï¼šæˆ˜æ–—ä¸­ï¼ˆæ— ä»»åŠ¡å˜åŒ–ï¼‰**
- V2ï¼šæ¯2ç§’æ‰«æ2-10msï¼Œå¹³å‡1-5ms/ç§’
- V3ï¼š**0mså¼€é”€**
- **æå‡ï¼šæ— é™å€**ï¼ˆå®Œå…¨æ¶ˆé™¤ï¼‰

**åœºæ™¯2ï¼šä»»åŠ¡å®Œæˆæ—¶**
- V2ï¼šä¸‹ä¸€æ¬¡å‘¨æœŸæ‰«æï¼ˆ0-2ç§’å»¶è¿Ÿï¼‰+ 2-10msæ‰«æå¼€é”€
- V3ï¼š**ç«‹å³å“åº” + <0.1msç§»é™¤å¼€é”€**
- **æå‡ï¼š20-100å€**

**åœºæ™¯3ï¼šå…³å¡åŠ è½½æ—¶**
- V2ï¼š6-20msï¼ˆåˆå§‹åŒ–ï¼‰ + é¦–æ¬¡æ‰«æ2-10ms
- V3ï¼š11-30msï¼ˆåˆå§‹åŒ–+æ‰«æï¼‰
- **å½±å“ï¼šå¯å¿½ç•¥**ï¼ˆä¸€æ¬¡æ€§å¼€é”€ï¼Œéæ¸¸æˆå¾ªç¯ï¼‰

---

## ğŸ”‘ å…³é”®ä¼˜åŒ–ç‚¹

### 1. æ¶ˆé™¤å‘¨æœŸæ€§æ‰«æ

**V2é—®é¢˜**ï¼š
```csharp
// âŒ æ¯2ç§’è½®è¯¢ï¼Œå³ä½¿ä»»åŠ¡æ²¡å˜åŒ–ä¹Ÿæ‰«æ
if (Time.time - _lastScanTime > 2f)
{
    RefreshQuestZones(); // é‡å¤æ‰«æç›¸åŒå†…å®¹
}
```

**V3ä¼˜åŒ–**ï¼š
```csharp
// âœ… å…³å¡åŠ è½½æ—¶æ‰«æä¸€æ¬¡ï¼Œåç»­ä»…é€šè¿‡äº‹ä»¶æ›´æ–°
private void OnLevelLoaded()
{
    ScanAllQuestZones(); // ä»…æ‰§è¡Œä¸€æ¬¡
}
```

### 2. äº‹ä»¶é©±åŠ¨æ›´æ–°

**V2é—®é¢˜**ï¼š
- å‘¨æœŸæ‰«æå¯èƒ½æœ‰0-2ç§’å»¶è¿Ÿ
- æ‰«ææ‰€æœ‰ä»»åŠ¡ï¼ŒåŒ…æ‹¬æœªå˜åŒ–çš„

**V3ä¼˜åŒ–**ï¼š
```csharp
// âœ… ä»»åŠ¡å®Œæˆæ—¶ç«‹å³è§¦å‘ï¼Œç²¾å‡†ç§»é™¤
private void OnTaskFinished(Quest quest, Task task)
{
    // ä»…ç§»é™¤å·²å®Œæˆçš„ä»»åŠ¡æ ‡è®°ï¼Œä¸æ‰«æå…¶ä»–ä»»åŠ¡
    RemoveSpecificTaskMarker(quest, task);
}
```

### 3. æ™ºèƒ½ç¼“å­˜ç®¡ç†

**æ•°æ®ç»“æ„**ï¼š
```csharp
// Key: Quest_{questId}_Task_{taskIndex}
private Dictionary<string, QuestZoneData> _questZones;
```

**ä¼˜åŠ¿**ï¼š
- O(1)æŸ¥æ‰¾å’Œåˆ é™¤
- ç²¾å‡†å®šä½ç‰¹å®šä»»åŠ¡
- é¿å…éå†æ‰€æœ‰ä»»åŠ¡

---

## ğŸ® æ¸¸æˆäº‹ä»¶API

### å¯ç”¨äº‹ä»¶ï¼ˆæ— éœ€Hookï¼‰

| äº‹ä»¶å | è§¦å‘æ—¶æœº | ç”¨é€” |
|--------|---------|------|
| `QuestManager.OnTaskFinishedEvent` | å•ä¸ªä»»åŠ¡ç›®æ ‡å®Œæˆ | ç§»é™¤ä»»åŠ¡åœ°ç‚¹æ ‡è®° |
| `Quest.onQuestCompleted` | æ•´ä¸ªä»»åŠ¡å®Œæˆ | ç§»é™¤ä»»åŠ¡æ‰€æœ‰æ ‡è®° |
| `Quest.onQuestStatusChanged` | ä»»åŠ¡çŠ¶æ€å˜åŒ– | æ›´æ–°ä»»åŠ¡ç‰©å“åˆ—è¡¨ |
| `Quest.onQuestActivated` | ä»»åŠ¡æ¿€æ´» | æ·»åŠ ä»»åŠ¡ç‰©å“æ£€æµ‹ |
| `BuildingManager.OnBuildingBuilt` | å»ºç­‘å®Œæˆ | æ›´æ–°å»ºç­‘ææ–™éœ€æ±‚ |
| `LevelManager.OnAfterLevelInitialized` | å…³å¡åŠ è½½å®Œæˆ | é‡æ–°æ‰«æä»»åŠ¡åœ°ç‚¹ |

### äº‹ä»¶è¦†ç›–ç‡
- âœ… ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸï¼š100%è¦†ç›–
- âœ… è§¦å‘æ—¶æœºï¼šå‡†ç¡®å¯é 
- âœ… æ€§èƒ½å¼€é”€ï¼šæä½ï¼ˆ<0.1msï¼‰
- âœ… **æ— éœ€è‡ªå®šä¹‰Hook**

---

## ğŸ“ˆ æ€§èƒ½æå‡æ€»ç»“

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | æå‡å¹…åº¦ |
|------|---------|
| æ¶ˆé™¤å‘¨æœŸæ‰«æå¼€é”€ | **100%** |
| äº‹ä»¶å“åº”é€Ÿåº¦ | **20-100å€** |
| å¹³å‡æ¯å¸§å¼€é”€é™ä½ | **10-30å€** |
| å†…å­˜å ç”¨ | æŒå¹³ï¼ˆ~3.5KBï¼‰ |

### ç”¨æˆ·ä½“éªŒæå‡

1. **âœ… é›¶å»¶è¿Ÿå“åº”**
   - ä»»åŠ¡å®Œæˆæ—¶ç«‹å³ç§»é™¤æ ‡è®°
   - æ— 0-2ç§’å‘¨æœŸå»¶è¿Ÿ

2. **âœ… å¸§ç‡æ›´ç¨³å®š**
   - æ¶ˆé™¤æ¯2ç§’çš„2-10mså³°å€¼
   - å¸§ç‡æ³¢åŠ¨å‡å°‘

3. **âœ… ç”µæ± ç»­èˆª**
   - æ¶ˆé™¤ä¸å¿…è¦çš„CPUå”¤é†’
   - é™ä½åå°åŠŸè€—

---

## ğŸš€ å®æ–½å»ºè®®

### ä¼˜å…ˆçº§æ’åº

**P0ï¼ˆç«‹å³å®æ–½ï¼‰**ï¼š
1. âœ… ä¿®æ”¹ `QuestZoneTracker` ä¸ºäº‹ä»¶é©±åŠ¨
2. âœ… åˆ é™¤ `Update()` æ–¹æ³•
3. âœ… è®¢é˜… `OnTaskFinishedEvent` å’Œ `onQuestCompleted`

**P1ï¼ˆå»ºè®®å®æ–½ï¼‰**ï¼š
1. æ·»åŠ äº‹ä»¶è§¦å‘æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
2. æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆéªŒè¯ä¼˜åŒ–æ•ˆæœï¼‰
3. è¾¹ç•Œæµ‹è¯•ï¼ˆå¿«é€Ÿå®Œæˆå¤šä¸ªä»»åŠ¡ï¼‰

**P2ï¼ˆå¯é€‰ï¼‰**ï¼š
1. æ‰©å±•æ”¯æŒæ›´å¤šä»»åŠ¡ç±»å‹
2. æ·»åŠ ä»»åŠ¡åœ°ç‚¹é¢„æµ‹ï¼ˆæå‰æ‰«æï¼‰

### å®æ–½æ­¥éª¤

1. **ä¿®æ”¹QuestZoneTracker**ï¼ˆ30åˆ†é’Ÿï¼‰
   - æ·»åŠ äº‹ä»¶è®¢é˜…
   - åˆ é™¤Update()
   - å®ç°OnTaskFinished/OnQuestCompleted

2. **ä¿®æ”¹QuestMarkerCollectionService**ï¼ˆ10åˆ†é’Ÿï¼‰
   - åˆ é™¤Update()è°ƒç”¨
   - ä¿®æ”¹Initialize()é€»è¾‘

3. **æµ‹è¯•éªŒè¯**ï¼ˆ30åˆ†é’Ÿï¼‰
   - å…³å¡åŠ è½½æ—¶ä»»åŠ¡æ ‡è®°æ­£å¸¸æ˜¾ç¤º
   - å®Œæˆä»»åŠ¡æ—¶æ ‡è®°ç«‹å³æ¶ˆå¤±
   - æ€§èƒ½ç›‘æ§éªŒè¯å¼€é”€é™ä½

4. **é…ç½®æ¸…ç†**ï¼ˆ5åˆ†é’Ÿï¼‰
   - åˆ é™¤ `QuestZoneScanInterval` é…ç½®é¡¹
   - æ›´æ–°æ–‡æ¡£è¯´æ˜

**é¢„è®¡æ€»æ—¶é—´**ï¼š1-2å°æ—¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ½œåœ¨é—®é¢˜

1. **é—®é¢˜**ï¼šäº‹ä»¶è§¦å‘å¤±è´¥å¯¼è‡´æ ‡è®°æ®‹ç•™
   **è§£å†³**ï¼šæ·»åŠ æ‰‹åŠ¨åˆ·æ–°APIä½œä¸ºå¤‡ç”¨

2. **é—®é¢˜**ï¼šå…³å¡å¿«é€Ÿé‡è½½å¯¼è‡´äº‹ä»¶é‡å¤è®¢é˜…
   **è§£å†³**ï¼šåœ¨Initialize()å‰å…ˆCleanup()

3. **é—®é¢˜**ï¼šä»»åŠ¡å®Œæˆäº‹ä»¶å»¶è¿Ÿè§¦å‘
   **è§£å†³**ï¼šæ·»åŠ è¶…æ—¶æ£€æµ‹ï¼ˆ5ç§’åå¼ºåˆ¶åˆ·æ–°ï¼‰

### å‘åå…¼å®¹

- âœ… ä¸å½±å“ç°æœ‰ESPåŠŸèƒ½
- âœ… é…ç½®æ–‡ä»¶å…¼å®¹ï¼ˆåˆ é™¤çš„é…ç½®é¡¹ä¼šè¢«å¿½ç•¥ï¼‰
- âœ… äº‹ä»¶ç³»ç»Ÿç¨³å®šå¯é ï¼ˆæ¸¸æˆåŸç”ŸAPIï¼‰

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

| æ”¹è¿›ç‚¹ | æè¿° |
|--------|------|
| âœ… **æ¶ˆé™¤å‘¨æœŸæ‰«æ** | ä»æ¯2ç§’æ‰«ææ”¹ä¸ºäº‹ä»¶é©±åŠ¨ |
| âœ… **é›¶è½®è¯¢å¼€é”€** | å®Œå…¨åŸºäºäº‹ä»¶ï¼Œæ— Update()è°ƒç”¨ |
| âœ… **ç«‹å³å“åº”** | ä»»åŠ¡å®Œæˆæ—¶<0.1msç§»é™¤æ ‡è®° |
| âœ… **æ€§èƒ½æå‡** | å¹³å‡å¼€é”€é™ä½10-30å€ |
| âœ… **æ— éœ€Hook** | æ¸¸æˆåŸç”Ÿäº‹ä»¶è¦†ç›–å®Œæ•´ |

### æœ€ç»ˆæ•ˆæœ

**V3ä»»åŠ¡æ ‡è®°ç³»ç»Ÿæ€§èƒ½**ï¼š
- åˆå§‹åŒ–ï¼š11-30msï¼ˆå…³å¡åŠ è½½æ—¶ï¼Œä¸€æ¬¡æ€§ï¼‰
- æ¯å¸§å¼€é”€ï¼š**0.05-0.1ms**ï¼ˆä»…è·ç¦»æ›´æ–°ï¼‰
- äº‹ä»¶å“åº”ï¼š**<0.1ms**ï¼ˆä»»åŠ¡å®Œæˆæ—¶ï¼‰
- å†…å­˜å ç”¨ï¼š~3.5KB

**è¯„çº§**ï¼šâ­â­â­â­â­ **ï¼ˆæè‡´æ€§èƒ½ä¼˜åŒ–ï¼Œç”Ÿäº§å°±ç»ªï¼‰**

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-01-19  
**ä¼˜åŒ–ç±»å‹**ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆæ¶ˆé™¤å‘¨æœŸæ‰«æï¼‰  
**é¢„æœŸæå‡**ï¼š10-30å€  
**é£é™©è¯„ä¼°**ï¼šğŸŸ¢ ä½é£é™©ï¼ˆæ¸¸æˆåŸç”Ÿäº‹ä»¶ç¨³å®šï¼‰
